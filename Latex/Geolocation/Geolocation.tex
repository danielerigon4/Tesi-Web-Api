\documentclass[italian]{article}
\usepackage[T1]{fontenc}
\usepackage[utf8]{inputenc}
\usepackage{lmodern}
\usepackage{hyperref}
\usepackage[a4paper,top=3cm,bottom=3cm,left=2.5cm,right=2.5cm]{geometry}
\usepackage[italian]{babel}
\usepackage{listings} %Per inserire codice
\usepackage[usenames]{color} %Per permettere la colorazione dei caratteri 
%Define the listing package
\usepackage{listings} %code highlighter
\usepackage{color} %use color
\usepackage{graphicx}
\graphicspath{ {./images/} }
\definecolor{mygreen}{rgb}{0,0.6,0}
\definecolor{mygray}{rgb}{0.5,0.5,0.5}
\definecolor{mymauve}{rgb}{0.58,0,0.82}

%Customize a bit the look
\lstset{ %
	backgroundcolor=\color{white}, % choose the background color; you must add \usepackage{color} or \usepackage{xcolor}
	basicstyle=\footnotesize, % the size of the fonts that are used for the code
	breakatwhitespace=false, % sets if automatic breaks should only happen at whitespace
	breaklines=true, % sets automatic line breaking
	captionpos=b, % sets the caption-position to bottom
	commentstyle=\color{mygreen}, % comment style
	deletekeywords={...}, % if you want to delete keywords from the given language
	escapeinside={\%*}{*)}, % if you want to add LaTeX within your code
	extendedchars=true, % lets you use non-ASCII characters; for 8-bits encodings only, does not work with UTF-8
	frame=single, % adds a frame around the code
	keepspaces=true, % keeps spaces in text, useful for keeping indentation of code (possibly needs columns=flexible)
	keywordstyle=\color{blue}, % keyword style
	% language=Octave, % the language of the code
	morekeywords={*,...}, % if you want to add more keywords to the set
	numbers=left, % where to put the line-numbers; possible values are (none, left, right)
	numbersep=5pt, % how far the line-numbers are from the code
	numberstyle=\tiny\color{mygray}, % the style that is used for the line-numbers
	rulecolor=\color{black}, % if not set, the frame-color may be changed on line-breaks within not-black text (e.g. comments (green here))
	showspaces=false, % show spaces everywhere adding particular underscores; it overrides 'showstringspaces'
	showstringspaces=false, % underline spaces within strings only
	showtabs=false, % show tabs within strings adding particular underscores
	stepnumber=1, % the step between two line-numbers. If it's 1, each line will be numbered
	stringstyle=\color{mymauve}, % string literal style
	tabsize=2, % sets default tabsize to 2 spaces
	title=\lstname % show the filename of files included with \lstinputlisting; also try caption instead of title
}
%END of listing package%

\definecolor{darkgray}{rgb}{.4,.4,.4}
\definecolor{purple}{rgb}{0.65, 0.12, 0.82}

%define Javascript language
\lstdefinelanguage{JavaScript}{
	keywords={typeof, new, true, false, catch, function, return, null, catch, switch, var, if, in, while, do, else, case, break},
	keywordstyle=\color{blue}\bfseries,
	ndkeywords={class, export, boolean, throw, implements, import, this},
	ndkeywordstyle=\color{darkgray}\bfseries,
	identifierstyle=\color{black},
	sensitive=false,
	comment=[l]{//},
	morecomment=[s]{/*}{*/},
	commentstyle=\color{purple}\ttfamily,
	stringstyle=\color{red}\ttfamily,
	morestring=[b]',
	morestring=[b]"
}

\lstset{
	language=JavaScript,
	extendedchars=true,
	basicstyle=\footnotesize\ttfamily,
	showstringspaces=false,
	showspaces=false,
	numbers=left,
	numberstyle=\footnotesize,
	numbersep=9pt,
	tabsize=2,
	breaklines=true,
	showtabs=false,
	captionpos=b
}
\author{
	Daniele Rigon - 857319 \\
}


\begin{document}
	
\title{Tesi - Geolocation API}
\maketitle

\tableofcontents
\pagebreak


\section{Overview}
La Geolocation API viene utilizzata per ottenere la posizione geografica di un utente. 
Poiché questo può compromettere la privacy la posizione non è disponibile a meno che l'utente non la approvi: su un dispositivo mobile avremo un set di coordinate provenienti dal sensore GPS mentre su un portatile potremo usare il posizionamento legato all’ip della connessione internet.

\section{Specifiche}

\subsection{Oggetto della geolocalizzazione}
Le API di geolocalizzazione sono pubblicate tramite l'oggetto navigator.geolocation. Se l'oggetto esiste, il servizio di geolocalizzazione è disponibile. Per testare l'esistenza di tale oggetto:
\begin{lstlisting}[language=JavaScript]
	if ("geolocation" in navigator) {
	/* la geolocalizzazione e disponibile */
	} else {
	/* la geolocalizzazione non e disponibile */
	}
\end{lstlisting}

\subsection{Metodi}
Ci sono solamente tre metodi a disposizione: getCurrentPosition, watchPosition e clearWatch. I primi due sono utili a ottenere la posizione corrente mentre il terzo serve ad annullare la ricerca della posizione corrente. 
La differenza tra i primi due va ricercata nella loro periodicità, mentre il primo metodo fornisce il dato una sola volta, il secondo si attiva automaticamente ogni qualvolta la posizione cambi, o ogni tot intervallo di tempo.
La sintassi per invocare questi metodi è la seguente:
\begin{lstlisting}[language=JavaScript]
navigator.geolocation.getCurrentPosition(inCasoDiSuccesso, opzInCasoDiErrore, opzioni); 
navigator.geolocation.watchPosition(inCasoDiSuccesso, opzInCasoDiErrore, opzioni);
\end{lstlisting}

\subsubsection{GetCurrentPosition}
\begin{lstlisting}[language=JavaScript]
navigator.geolocation.getCurrentPosition(function(position) {
	do_something(position.coords.latitude,position.coords.longitude);
});
\end{lstlisting}
L'esempio chiama la funzione dosomething() quando la posizione viene calcolata. Un esempio concreto potrebbe essere il seguente:
\pagebreak
\begin{lstlisting}
/*	Nel frammento di codice appena illustrato possiamo vedere tutte le informazioni estraibili dalla struttura Position. Chiaramente, a seconda del device sul quale viene effettuata l interrogazione, non tutte saranno sempre disponibili, in tal caso il loro valore sara impostato a null.*/
function success(position) {
	document.getElementById('latitude').innerHTML = position.coords.latitude;
	document.getElementById('longitude').innerHTML = position.coords.longitude;
	document.getElementById('position-accuracy').innerHTML = position.coords.accuracy;
	
	document.getElementById('altitude').innerHTML = position.coords.altitude ? position.coords.altitude :
		'unavailable';
	document.getElementById('altitude-accuracy').innerHTML = position.coords.altitudeAccuracy ? position.coords.altitudeAccuracy :
		'unavailable';
	document.getElementById('heading').innerHTML = position.coords.heading ? position.coords.heading :
		'unavailable';
	document.getElementById('speed').innerHTML = position.coords.speed ? position.coords.speed :
		'unavailable';
}
\end{lstlisting}
\begin{figure}[h]
	\centering
	\includegraphics[width=1\linewidth]{img}
	\caption{Prova info Geolocation.}
	\label{fig:Info Geolocation}
\end{figure}
In caso invece si verifichi un errore la funzione preposta deve accettare anch’essa un parametro, un oggetto di tipo PositionError  contenente un codice di errore ed un messaggio ad uso di debug, ad esempio:
\begin{lstlisting}
	message.opzInCasoDiErrore = function(error){ 
		alert( "Errore " + error.code + ": " + error.message);
	}
\end{lstlisting}

\subsubsection{WatchPosition}
Se la posizione cambia (perché il dispositivo si sposta o perché viene calcolata una posizione più accurata), si può settare una funzione che viene chiamata quando la posizione attuale si aggiorna. Basta usare la funzione watchPosition(), che ha gli stessi parametri di input di getCurrentPosition(). Questa funzione viene chiamata più volte così da permettere al browser di sapere sempre la posizione del dispositivo. La funzione di errore è opzionale come lo era per getCurrentPosition().

\begin{lstlisting}
var watchID = navigator.geolocation.watchPosition(function(position) {
	do_something(position.coords.latitude, position.coords.longitude);
});
\end{lstlisting}
Il metodo watchPosition() ritorna un ID numerico che può essere usato per identificare univocamente il controllo della posizione; 
\\
Nota: si può usare questo valore insieme al metodo clearWatch() per fermare il controllo della posizione.
\begin{lstlisting}
navigator.geolocation.clearWatch(watchID);
\end{lstlisting}
Infatti, un'invocazione del metodo watchPosition può essere successivamente interrotta utilizzando la funzione clearWatch, 
come nell’esempio seguente:
\begin{lstlisting}
<script> 
var id_watch = null;
/*some code*/
watchId = navigator.geolocation.watchPosition(success, error, positionOptions);
// ...
</script> 
\end{lstlisting}
\subsubsection{ClearPosition}
Viene usato il metodo clearWatch() per annullare il monitoraggio della posizione.
\begin{lstlisting}
navigator.geolocation.clearWatch(watchId);
/*Il numero ID e quello restituito dal metodo watchPosition() descritto precedentemente*/
\end{lstlisting}
\section{Problemi sicurezza/privacy}
Uno dei principali problemi con l'API di geolocalizzazione è rappresentato dagli attacchi di cross-site scripting (XSS) dovuti al fatto che gli oggetti per tracciare le coordinate (latitudine e longitudine) risiedono all'interno del DOM, il quale è accessibile con JavaScript. La vulnerabilità XSS potrebbe essere sfruttata per determinare la posizione della vittima e potrebbe verificarsi l'invasione della privacy.
A causa del fatto che gli utenti si fidano del sito web, questi si fidano anche della richiesta e condividono 
la loro posizione. 
La cosa peggiore è che se l'utente non disabilita il tracciamento il browser continuerà a esporre la posizione della vittima all'attaccante.
Supponiamo che un utente malintenzionato abbia rilevato una vulnerabilità XSS in un sito Web; tutto ciò che dovra fare è fare in modo che la vittima esegua il seguente codice JavaScript per rubare la posizione.
Il codice utilizza le proprietà DOM cords.latitude e cords.langitude per determinare rispettivamente la latitudine / longitudine e le memorizza in una variabile. Successivamente il codice JavaScript invia i dati al dominio dell'attaccante, in modo diverso a seconda di come è stato configurata la richiesta.	
\pagebreak
\begin{lstlisting}
<script>
	function showPosition(position){
		var pos="Latitude: " + position.coords.latitude + "<br>Longitude: " + position.coords.longitude;
		document.getElementById("mydiv").innerHTML = pos;
	}
	function getLocation(){
		navigator.geolocation.getCurrentPosition(showPosition);
	}
	getLocation();
</script>
\end{lstlisting}
\section{Supporto compatibilità web}
manca mobile, fare meglio desktop, vedi payment
\begin{figure}[h]
	\centering
	\includegraphics[width=1\linewidth]{web1}
	\caption{Browser compatibility}
	\label{fig:Browser compatibility}
\end{figure}
\end{document}